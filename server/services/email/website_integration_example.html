<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yacht AI - ChatLLM with Email Search</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .chat-container { background: #f5f5f5; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .email-integration { background: #e3f2fd; border-radius: 10px; padding: 20px; margin: 20px 0; border-left: 5px solid #2196f3; }
        .connect-btn { background: #0078d4; color: white; padding: 15px 30px; border: none; border-radius: 5px; text-decoration: none; display: inline-block; margin: 10px 0; font-size: 16px; cursor: pointer; }
        .connect-btn:hover { background: #106ebe; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .status.connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.disconnected { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .search-box { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; margin: 10px 0; }
        .search-btn { background: #28a745; color: white; padding: 15px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .email-results { background: white; border-radius: 10px; padding: 20px; margin: 20px 0; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>üö¢ Yacht AI - ChatLLM with Email Search</h1>
    
    <div class="chat-container">
        <h2>üí¨ Chat Interface</h2>
        <p><strong>User:</strong> "Search my emails for yacht maintenance contracts from last month"</p>
        
        <!-- Email Integration Status -->
        <div id="email-status" class="email-integration">
            <h3>üìß Microsoft Email Integration</h3>
            <div id="connection-status" class="status disconnected">
                ‚ùå Microsoft account not connected
            </div>
            <p>Connect your Microsoft email account to enable email search in ChatLLM conversations.</p>
            
            <!-- This is the key integration point -->
            <a href="http://localhost:8003/register?user_id=USER_12345" 
               class="connect-btn" 
               id="connect-email-btn">
                üìß Connect Microsoft Account
            </a>
            
            <!-- Email search interface (hidden until connected) -->
            <div id="email-search" style="display: none;">
                <input type="text" class="search-box" placeholder="Ask AI to search your emails..." id="search-input">
                <button class="search-btn" onclick="searchEmails()">üîç Search Emails</button>
            </div>
        </div>
        
        <div id="search-results" class="email-results" style="display: none;">
            <h4>üì¨ Email Search Results</h4>
            <div id="results-content"></div>
        </div>
    </div>

    <script>
    // Check if user has email connected
    async function checkEmailConnection() {
        try {
            const response = await fetch('http://localhost:8001/api/users');
            const data = await response.json();
            
            // Check if current user is in the registered users list
            const currentUserId = 'USER_12345'; // This would come from your user session
            const userConnected = data.users.some(user => user.user_id === currentUserId);
            
            if (userConnected) {
                document.getElementById('connection-status').innerHTML = '‚úÖ Microsoft account connected';
                document.getElementById('connection-status').className = 'status connected';
                document.getElementById('connect-email-btn').style.display = 'none';
                document.getElementById('email-search').style.display = 'block';
            }
        } catch (error) {
            console.log('Email service not available:', error);
        }
    }

    // Search emails function
    async function searchEmails() {
        const searchQuery = document.getElementById('search-input').value;
        if (!searchQuery) return;

        const searchPayload = {
            query: searchQuery,
            filters: {
                date_filter: "receivedDateTime ge 2024-01-01T00:00:00.000Z",
                sender_filter: "",
                has_attachments: false
            },
            order_by: "receivedDateTime desc",
            top: 10,
            select_fields: ["id", "subject", "from", "receivedDateTime", "bodyPreview"],
            user_context: {
                user_id: "USER_12345",
                yacht_id: "yacht_12345", 
                session_id: "session_12345"
            }
        };

        try {
            const response = await fetch('http://localhost:8001/api/email/search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(searchPayload)
            });

            const results = await response.json();
            displayEmailResults(results);
        } catch (error) {
            console.error('Email search failed:', error);
        }
    }

    // Display email results
    function displayEmailResults(results) {
        const resultsDiv = document.getElementById('results-content');
        const resultsContainer = document.getElementById('search-results');
        
        if (results.emails && results.emails.length > 0) {
            let html = '<ul>';
            results.emails.forEach(email => {
                html += `<li><strong>${email.subject}</strong><br>
                         From: ${email.from}<br>
                         Date: ${email.receivedDateTime}<br>
                         Preview: ${email.bodyPreview}</li><br>`;
            });
            html += '</ul>';
            resultsDiv.innerHTML = html;
        } else {
            resultsDiv.innerHTML = '<p>No emails found for your search query.</p>';
        }
        
        resultsContainer.style.display = 'block';
    }

    // Check connection status on page load
    checkEmailConnection();
    
    // Check every 30 seconds for new connections
    setInterval(checkEmailConnection, 30000);
    </script>
</body>
</html>